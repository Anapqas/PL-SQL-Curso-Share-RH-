CREATE TABLE Fornecedores(
ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1)
,Empresa VARCHAR2 (50)
,CNPJ CHAR(14) NOT NULL UNIQUE
,Email_f VARCHAR2 (150) NOT NULL UNIQUE
,Telefone  VARCHAR2 (15)
,PRIMARY KEY (ID)
);


CREATE TABLE Produtos (
ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 100 INCREMENT BY 10)
,ID_fornecedor NUMBER
,Categoria VARCHAR2 (30) NOT NULL
,Produto VARCHAR2 (50) NOT NULL UNIQUE
,Preco_compra NUMBER NOT NULL 
,Preco_venda NUMBER NOT NULL
,Qt_estoque NUMBER
,Qt_minima NUMBER
,PRIMARY KEY (ID)
,CONSTRAINT fk_produtos_fornecedores FOREIGN KEY (ID_fornecedor) REFERENCES Fornecedores(ID)
);



CREATE TABLE Clientes (
ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 100 INCREMENT BY 10)
,Nome VARCHAR2(150)
,dt_nascimento DATE
,CPF CHAR (11) NOT NULL UNIQUE 
,Telefone VARCHAR2 (15) 
,Email_c VARCHAR2(150)
,PRIMARY KEY (ID)
);

CREATE TABLE Vendas (
ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 360 INCREMENT BY 10)
,ID_cliente NUMBER
,Data DATE
,Total NUMBER 
,PRIMARY KEY (ID)
,CONSTRAINT fk_vendas_clientes FOREIGN KEY (ID_cliente) REFERENCES Clientes (ID) 
);

CREATE TABLE Itens_da_venda (
ID_produto NUMBER
,ID_venda NUMBER
,Quantidade NUMBER
,Valor_unitario NUMBER
,Valor_total NUMBER
,CONSTRAINT fk_itensdavenda_produtos FOREIGN KEY (ID_produto) REFERENCES Produtos (ID) 
,CONSTRAINT fk_itensdavenda_vendas FOREIGN KEY (ID_venda) REFERENCES Vendas (ID)
,CONSTRAINT chave_composta PRIMARY KEY (ID_produto, ID_venda)
);

ALTER TABLE itens_da_venda
ADD CONSTRAINT ck_peso
CHECK (quantidade>=0.05);


INSERT INTO FORNECEDORES (Empresa, CNPJ, Email_f, Telefone) VALUES ('Armazém Santa Filomena ', '95714161000153', 'santa.filomena@hotmail.com', '1138487533');
INSERT INTO FORNECEDORES (Empresa, CNPJ, Email_f, Telefone) VALUES ('Rmoura', '82988710000136', 'rmoura@rmoura.com.br', '1138487933');
INSERT INTO FORNECEDORES (Empresa, CNPJ, Email_f, Telefone) VALUES ('Qualy', '39749360000126', 'qualy@qualy.com.br', '1136151935');
INSERT INTO FORNECEDORES (Empresa, CNPJ, Email_f, Telefone) VALUES ('Vida em Grãos', '47352267000101', 'vida em grãos@vida em grãos.com.br', '1136403786');
INSERT INTO FORNECEDORES (Empresa, CNPJ, Email_f, Telefone) VALUES ('50 grain myruss', '71813788000101', '50 grain myruss@50 grain myruss.com.br', '1136376756');


INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Amendoa Crua', 55.2, 74.52);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Castanhas', 'Amendoa Laminada ', 56.6, 76.41);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Castanhas', 'Amendoa Tostada Sem Sal', 57, 76.95);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Castanhas', 'Amendoim Doce', 14.9, 20.12);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Castanhas', 'Amendoim Japonês ', 13.5, 18.23);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Amendoim Ovinho', 10.7, 14.45);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Castanhas', 'Amendoim Com Sal', 11.1, 14.99);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Castanhas', 'Amendoim Sem Sal', 11.1, 14.99);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Castanhas', 'Amendoim Cebola E Salsa Crocante', 13.5, 18.23);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Castanhas', 'Amendoim Crocante Natural', 13.5, 18.23);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Avelã Sem Casca', 74.59, 100.69);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Castanha De Caju Media Com Sal', 39, 52.65);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Castanha De Caju Slw1 Sem Sal', 58.8, 79.38);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Castanha Do Para ', 41, 55.35);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Castanha Do Para Quebrada', 28, 37.8);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Mix Agridoce', 74.5, 100.57);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Mix Castanhas', 71.8, 96.93);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Noz Pecan Sem Casca', 63.5, 85.72);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Nozes Quartilhos', 31.2, 42.12);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Nozes  Mariposa', 60.7, 81.95);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Castanhas', 'Pistache', 78.7, 106.25);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Cereais/farelo', 'Aveia Em Flocos Grossa', 3, 4.05);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Cereais/farelo', 'Aveia Em Flocos Média', 3.1, 4.19);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Cereais/farelo', 'Coco Ralado Médio', 19.4, 26.19);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (4, 'Cereais/farelo', 'Farelo De Aveia', 3.4, 4.59);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Cereais/farelo', 'Granola Tradicional (Com Frutas)', 16, 21.6);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Cereais/farelo', 'Granola Chocolate', 21.4, 28.89);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Cereais/farelo', 'Granola Com Açúcar', 15.2, 20.52);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Cereais/farelo', 'Granola Salgada', 13.5, 18.23);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Cereais/farelo', 'Corn Choco Ball', 10.3, 13.91);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Cereais/farelo', 'Corn Flakes Natural (Sucrilhos)', 13.9, 18.77);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Cereais/farelo', 'Corn Sugar ', 13.1, 17.69);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Cereais/farelo', 'Corn Sugar Leite Condensado', 14.1, 19.04);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Chás', 'Boldo Chileno', 35.8, 48.33);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Chás', 'Camomila', 22.5, 30.38);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Chás', 'Cha Preto', 20, 27);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Chás', 'Cha Verde', 9.5, 12.83);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Chás', 'Erva Cidrera', 15.8, 21.33);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Chás', 'Erva Doce ', 25.5, 34.43);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Chás', 'Hibisco ', 13.7, 18.5);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Chás', 'Hortela', 9.9, 13.37);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Chás', 'Melissa', 19.2, 25.92);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (4, 'Chips', 'Chips De Banana Doce', 32.2, 43.47);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Chips', 'Chips De Banana Salgada ', 32.2, 43.47);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Fruta', 'Abacaxi Desidratado', 60, 81);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Fruta', 'Ameixa Sem Caroço', 13.49, 18.21);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (4, 'Fruta', 'Banana Passa', 68, 91.8);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Fruta', 'Cranberry', 31.8, 42.93);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Fruta', 'Damasco', 23.5, 31.73);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Fruta', 'Frutas Cristalizadas', 6, 8.1);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Fruta', 'Goiaba Desidratada', 67.8, 91.53);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Fruta', 'Gojiberry', 34.5, 46.58);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Fruta', 'Laranja Cristalizada', 45.67, 61.65);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Fruta', 'Limão Cristalizado', 41.3, 55.76);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Fruta', 'Maça Desidratada', 45.9, 61.97);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Fruta', 'Mamão Desidratado', 56.9, 76.82);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Fruta', 'Mix De Frutas Secas', 39.5, 53.33);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Fruta', 'Tamara Com Caroço ', 41.4, 55.89);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Fruta', 'Uva Passa Branca', 19.3, 26.06);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Fruta', 'Uva Passa Preta', 13.2, 17.82);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Grãos/Sementes', 'Amaranto Em Flocos', 19.6, 26.46);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (4, 'Grãos/Sementes', 'Bife De Pts', 32.8, 44.28);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Grãos/Sementes', 'Ervilha Partida', 5.9, 7.97);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Grãos/Sementes', 'Feijão Branco', 6.9, 9.32);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Grãos/Sementes', 'Feijão Fradinho', 4.2, 5.67);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Grãos/Sementes', 'Feijão Preto', 4.25, 5.74);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Grãos/Sementes', 'Feijão Azuki', 9.8, 13.23);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Grãos/Sementes', 'Gergelim Preto', 20.5, 27.68);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Grãos/Sementes', 'Gergelim Sem Casca', 16.5, 22.28);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Grãos/Sementes', 'Germe De Trigo Tostado', 18.5, 24.98);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Grãos/Sementes', 'Grão De Bico', 7.3, 9.86);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Grãos/Sementes', 'Lentilha ', 6.9, 9.32);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Grãos/Sementes', 'Lentilha Siria', 7.6, 10.26);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Grãos/Sementes', 'Semente De Linha Dourada', 8.2, 11.07);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Grãos/Sementes', 'Semente De Linhaça Marrom', 6.3, 8.51);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (4, 'Grãos/Sementes', 'Mix De Quinua', 8.9, 12.02);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Grãos/Sementes', 'Proteina De Ervilha Texturizada', 35.9, 48.47);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Grãos/Sementes', 'Proteína De Soja Clara Granulada', 8.5, 11.48);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Grãos/Sementes', 'Proteína De Soja Caramelo Granulada', 8.5, 11.48);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (1, 'Grãos/Sementes', 'Quinua Branca Grão', 14.5, 19.58);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (2, 'Grãos/Sementes', 'Semente De Abobora Sem Casca E Sem Sal', 22.5, 30.38);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (3, 'Grãos/Sementes', 'Semente De Aboora Com Casca E Com Sal', 23.5, 31.73);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Grãos/Sementes', 'Semente De Chia', 8.8, 11.88);
INSERT INTO PRODUTOS (ID_fornecedor, Categoria, Produto, Preco_compra, Preco_venda) VALUES (5, 'Grãos/Sementes', 'Semente De Girassol Sem Casca Sem Sal', 8.8, 11.88);

UPDATE PRODUTOS SET qt_estoque = 1;
UPDATE PRODUTOS SET qt_minima = 0.3;

INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('José Alves', '23/07/1984', '15024246810', '11988539420', 'j.a@gmail.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Jorge Andrade', '11/03/1952', '27694174870', '11987480167', 'jorginhogmail.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Gabriela Barbosa', '18/07/1976', '26697184850', '11986696358', 'barbosa73yahoo.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Gabriel Barros', '31/05/1981', '78151057858', '11988353639', 'gb90hotmail.com ');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Diego Batista', '16/01/1996', '94775033808', '11981617073', 'diego.batistaterra.com.br');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Daniel Bezerra', '18/08/2000', '78977473870', '11997682353', 'daniel_bezerragmail.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Francisca Nascimento', '04/11/1999', '55412233856', '11983879178', 'ff.neves90yahoo.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Joaquim Neves', '22/02/1982', '28765621891', '11998818942', 'joaquim.neves58hotmail.com ');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Carlos Nóbrega', '30/03/1964', '98280728821', '11989956529', 'c.nob78terra.com.br');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Anderson Nogueira', '23/04/1993', '33782468805', '11994625927', 'anderson98gmail.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Ana Maria Nunes', '11/11/1990', '32229174851', '11999337499', 'nunes78yahoo.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('George Pereira', '17/05/1988', '18592107830', '11996070854', 'george_perereirahotmail.com ');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('João Victor Pires', '10/07/1974', '16985729800', '11985785745', 'jo.piresterra.com.br');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Joaquim de Almeida', '28/01/1978', '75141109844', '11987571787', 'jodealgmail.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Jorge de Assis', '28/11/1964', '91727734807', '11987556879', 'deassis.66yahoo.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Camila Fernandes', '13/11/2003', '62117938809', '11989931409', 'cami.ferhotmail.com ');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Carlos Duarte', '11/09/1999', '32152763807', '11993469285', 'duarte_89terra.com.br');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('César Ferraz', '13/06/2001', '23594419819', '11985929331', 'cesar000hotmail.com ');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Cláudio dos Santos', '14/02/1974', '94847438892', '11989220459', 'santos_97terra.com.br');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Antônia Marques', '24/02/2003', '21759540803', '11991814191', 'antonia_marquesgmail.com');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Benedita Tomaz', '04/01/1988', '95219979825', '11995448276', 'benedita09hotmail.com ');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Bianca Duarte', '10/11/2000', '39622467890', '11945738274', 'bianca.duarteterra.com.br');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Breno Medeiros', '04/11/1981', '52032764806', '11987453241', 'breno01hotmail.com ');
INSERT INTO CLIENTES (Nome, dt_nascimento, CPF, Telefone, Email_c) VALUES ('Bruno Melo', '24/11/1978', '63657539859', '11987523413', 'melo.brunoterra.com.br');

INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (100, 140, '10/09/2021', 89.69);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (110, 120, '10/09/2021', 11.92);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (120, 110, '12/09/2021', 4.1);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (130, 260, '12/09/2021', 3.65);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (140, 310, '12/09/2021', 5.03);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (150, 120, '15/09/2021', 3.56);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (160, 310, '16/09/2021', 9.32);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (170, 240, '16/09/2021', 1.7);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (180, 130, '16/09/2021', 55.35);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (190, 310, '17/09/2021', 58.47);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (200, 270, '18/09/2021', 4.68);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (210, 300, '19/09/2021', 7.54);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (220, 190, '01/10/2021', 3.65);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (230, 290, '02/10/2021', 90.64);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (240, 130, '03/10/2021', 47.99);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (250, 210, '04/10/2021', 52.42);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (260, 240, '04/10/2021', 35.65);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (270, 200, '08/10/2021', 72.09);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (280, 120, '10/10/2021', 3.59);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (290, 280, '15/10/2021', 8.15);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (300, 130, '15/10/2021', 62.19);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (310, 310, '15/10/2021', 4.34);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (320, 270, '16/10/2021', 10.8);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (330, 300, '17/10/2021', 7.34);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (340, 330, '18/10/2021', 34.43);
INSERT INTO VENDAS (ID,ID_cliente, Data, Total) VALUES (350, 180, '19/10/2021', 1.84);

INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (820, 100, 0.3, 10.26, 3.08);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (220, 100, 0.2, 79.38, 15.88);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (250, 100, 0.05, 100.57, 5.03);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (360, 100, 0.4, 28.89, 11.56);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (110, 100, 0.5, 76.41, 38.21);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (870, 100, 0.7, 11.48, 8.04);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (800, 100, 0.8, 9.86, 7.89);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (730, 110, 0.3, 9.32, 2.8);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (190, 110, 0.5, 18.23, 9.12);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (290, 120, 0.05, 81.95, 4.1);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (190, 130, 0.2, 18.23, 3.65);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (200, 140, 0.05, 100.69, 5.03);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (930, 150, 0.3, 11.88, 3.56);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (660, 150, 0.5, 53.33, 26.67);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (730, 160, 1, 9.32, 9.32);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (840, 170, 0.2, 8.51, 1.7);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (230, 180, 1, 55.35, 55.35);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (670, 190, 0.6, 55.89, 33.53);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (810, 190, 0.8, 9.32, 7.46);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (890, 190, 0.2, 19.58, 3.92);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (830, 190, 0.5, 11.07, 5.54);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (690, 190, 0.45, 17.82, 8.02);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (500, 200, 0.35, 13.37, 4.68);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (250, 210, 0.075, 100.57, 7.54);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (180, 220, 0.2, 18.23, 3.65);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (220, 230, 1, 79.38, 79.38);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (400, 230, 0.6, 18.77, 11.26);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (300, 240, 0.2, 106.25, 21.25);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (520, 240, 0.45, 43.47, 19.56);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (370, 240, 0.35, 20.52, 7.18);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (210, 250, 0.075, 52.65, 3.95);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (260, 250, 0.5, 96.93, 48.47);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (610, 260, 0.67, 46.58, 31.21);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (800, 260, 0.45, 9.86, 4.44);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (540, 270, 0.89, 81, 72.09);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (820, 280, 0.35, 10.26, 3.59);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (800, 290, 0.2, 9.86, 1.97);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (400, 290, 0.329, 18.77, 6.18);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (710, 300, 0.465, 44.28, 20.59);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (200, 300, 0.05, 100.69, 5.03);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (610, 300, 0.785, 46.58, 36.57);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (640, 310, 0.07, 61.97, 4.34);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (250, 320, 0.5, 21.6, 10.8);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (560, 330, 0.08, 91.8, 7.34);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (480, 340, 1, 34.43, 34.43);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (340, 350, 0.4, 4.59, 1.84);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (520, 350, 0.5, 43.47, 21.74);
INSERT INTO ITENS_DA_VENDA (ID_produto, ID_venda, Quantidade,Valor_unitario, Valor_total ) VALUES (300, 350, 0.789, 106.25, 83.83);

/*views*/
CREATE VIEW receita_mensal AS (
    select 
        to_char(data, 'Month') as "Mês", 
        sum (total) as "R$" 
    from 
        vendas
    group by 
        to_char( data, 'Month')
);
select * from receita_mensal;

CREATE VIEW ticket_médio_mensal AS (
    select 
        to_char(data, 'Month') as "Mês", 
        round((sum (total)/count (distinct id_cliente)), 2) as "Ticket Médio - Mensal" 
    from 
        vendas
    group by 
        to_char(data, 'Month')
);
select * from ticket_médio_mensal;

CREATE VIEW fornecedores_impacto AS (
    select 
        sub.id_fornecedor as "Id", 
        f.empresa as "Empresa", 
        "Quantidade de produtos"
    from
        (select 
            id_fornecedor, 
            count(id) "Quantidade de produtos" 
        from 
            produtos
        group by 
            id_fornecedor)sub 
    join fornecedores f on f.id = sub.id_fornecedor
);

select * from  fornecedores_impacto 
order by "Quantidade de produtos" desc ;

CREATE VIEW valor_clientes AS (
    select 
        "Mês", sub.id_cliente as "Id", 
        cl.nome as "Nome", 
        "Valor Total (R$)"  
    from
        (select 
            to_char(data, 'Month') as "Mês", 
            id_cliente, 
            sum(total) as "Valor Total (R$)" 
        from 
            vendas  
        group by 
            to_char(data, 'Month'), 
            id_cliente) sub
    join 
        clientes cl on cl.id = sub.id_cliente
);

select * from valor_clientes 
order by "Mês", "Valor Total (R$)" desc;


CREATE VIEW visitas_clientes as (
    select 
         "Mês", sub.id_cliente as "Id", 
         cl.nome as "Nome", 
         "Número de visitas"  
    from
        (select 
            to_char(data, 'Month') as "Mês", 
            id_cliente, 
            count(id) as "Número de visitas" 
        from 
            vendas  
        group by 
            to_char(data, 'Month') , 
            id_cliente) sub
    join 
        clientes cl on cl.id = sub.id_cliente
);

select * from visitas_clientes 
order by  "Mês", "Número de visitas" desc;

CREATE VIEW qt_vendas_produtos AS(
    select 
        "Mês", 
        sub.id_produto as "Id", 
        pr.produto as "Produto", 
        "Quantidade de vendas"
    from
        (select 
            to_char(vendas.data, 'Month') as "Mês", id_produto, count(id_venda)as "Quantidade de vendas" 
        from 
            itens_da_venda
        join 
            vendas on vendas.id = itens_da_venda.id_venda
        group by 
            to_char(vendas.data, 'Month'), 
            id_produto) sub
    join   
        produtos pr on pr.id = sub.id_produto
);
select * from qt_vendas_produtos 
order by "Mês", "Quantidade de vendas" desc;

CREATE VIEW valor_vendas_produtos AS (
    select 
        "Mês", sub.id_produto as "Id", 
        pr.produto as "Produto", 
        "Valor (R$)" 
    from 
        (select 
           to_char(vendas.data, 'Month') as "Mês", 
           id_produto, 
           sum(valor_total) as "Valor (R$)" 
        from 
            itens_da_venda
        join vendas on vendas.id = itens_da_venda.id_venda
        group by 
            to_char(vendas.data, 'Month'), 
            id_produto) sub
    join 
        produtos pr on pr.id = sub.id_produto
);
select * from valor_vendas_produtos 
order by "Mês", "Valor (R$)" desc ;

/*procedures - RODAR funções e triggers ANTES*/

CREATE OR REPLACE PROCEDURE insere_cliente (
    pNome IN clientes.nome%TYPE,
    pDt_nasc IN clientes.dt_nascimento%TYPE,
    pCpf IN clientes.cpf%TYPE,
    pTelefone IN clientes.telefone%TYPE,
    pEmail_c IN clientes.email_c%TYPE
    )
IS
BEGIN
    INSERT INTO clientes (nome, dt_nascimento, cpf, telefone, email_c) VALUES
    (UPPER(pNome), pDt_nasc, pCpf, pTelefone, pEmail_c);
    COMMIT;
END;


CREATE OR REPLACE PROCEDURE insere_fornecedores (
    pEmpresa IN fornecedores.empresa%TYPE,
    pCnpj IN fornecedores.cnpj%TYPE,
    pEmail_f IN fornecedores.email_f%TYPE,
    pTelefone IN fornecedores.telefone%TYPE
    )
IS
BEGIN
    INSERT INTO fornecedores (empresa, cnpj, email_f, telefone) VALUES
    (UPPER(pEmpresa), pCnpj, pEmail_f, pTelefone);
    COMMIT;
END;


create or replace PROCEDURE insere_produto (
    pId_fornecedor IN produtos.id_fornecedor%TYPE,
    pCategoria IN produtos.categoria%TYPE,
    pProduto IN produtos.produto%TYPE,
    pPreco_compra IN produtos.preco_compra%TYPE,
    pPreco_venda IN produtos.preco_venda%TYPE,
    pQt_estoque IN produtos.qt_estoque%TYPE,
    pQt_minima IN produtos.qt_minima%TYPE
    )
IS   
BEGIN
    INSERT INTO produtos (id_fornecedor, categoria, produto, preco_compra, preco_venda, qt_estoque, qt_minima) VALUES
    (pId_fornecedor, upper(pCategoria), UPPER(pProduto), pPreco_compra, pPreco_venda, pQt_estoque, pQt_minima);
    COMMIT;
END;

create or replace PROCEDURE insere_venda_atualiza_estoque(
    
    venda_nova Boolean,
    
    pId_cliente vendas.id_cliente%TYPE,
    pData vendas.data%TYPE,
    pTotal_da_venda vendas.total%TYPE,
    
    pId_produto itens_da_venda.id_produto%TYPE,
    pQuantidade itens_da_venda.quantidade%TYPE,
    pValor_unit itens_da_venda.valor_unitario%TYPE,
    pValor_tot itens_da_venda.valor_total%TYPE
)
IS
    v_id_venda vendas.id%TYPE;
    v_quantidade itens_da_venda.quantidade%TYPE;
    v_qt_estoque produtos.qt_estoque%TYPE;
    
BEGIN
    v_quantidade := pQuantidade;
    v_quantidade := transforma_peso(v_quantidade);
    IF v_quantidade <0.05 THEN
        RAISE_APPLICATION_ERROR(-2020, 'Não é permitido vender menos de 50gr de cada produto');
    ELSE 
        CASE 
        WHEN venda_nova = True THEN

            INSERT INTO vendas (id_cliente, data, total) VALUES (pId_cliente, pData,  pTotal_da_venda)
            RETURNING id INTO  v_id_venda;

            INSERT INTO itens_da_venda (id_produto, id_venda, quantidade, valor_unitario, valor_total) 
            VALUES (pId_produto, v_id_venda, v_quantidade, pValor_unit, pValor_tot);

            UPDATE produtos 
            SET qt_estoque = (qt_estoque - v_quantidade) where id = pId_produto;

        WHEN venda_nova = False THEN
            select MAX(id) as id INTO v_id_venda from vendas;

            INSERT INTO itens_da_venda (id_produto, id_venda, quantidade, valor_unitario, valor_total) 
            VALUES (pId_produto, v_id_venda, v_quantidade, pValor_unit, pValor_tot);

            UPDATE produtos 
            SET qt_estoque = (qt_estoque - v_quantidade) where id = pId_produto;
        END CASE;
    END IF;
    
    select qt_estoque INTO v_qt_estoque from produtos where id = pId_produto;
    IF v_qt_estoque < 0.3 THEN
        dbms_output.put_line('Produto ' || pId_produto || ' abaixo do mínimo');
    END IF;
COMMIT;
END;


create or replace PROCEDURE get_cliente (
    v_id vendas.id%TYPE
)
IS
    TYPE personalizado IS RECORD (
        id vendas.id_cliente%TYPE,
        nome clientes.nome%TYPE
        );
    cl_info personalizado;

BEGIN
    select vendas.id_cliente, clientes.nome INTO cl_info.id, cl_info.nome
    from vendas
    join clientes on clientes.id = vendas.id_cliente
    where vendas.id = v_id;
    DBMS_OUTPUT.put_line('Id: '|| cl_info.id || ', Nome: ' || cl_info.nome);
END;

create or replace PROCEDURE get_produtos (
    p_id vendas.id%TYPE
)
IS
    TYPE personalizado IS RECORD (
    pr_id produtos.id%TYPE,
    pr_nome produtos.produto%TYPE
    );
    TYPE get_pr IS TABLE OF personalizado;
     v_linha get_pr;
BEGIN
    select 
        produtos.id, produtos.produto BULK COLLECT INTO v_linha
    from 
        produtos 
    join 
        itens_da_venda on produtos.id = itens_da_venda.id_produto
    join 
        vendas on vendas.id = itens_da_venda.id_venda
    where  
        vendas.id = p_id;
        
    FOR i IN   v_linha.FIRST..v_linha.LAST LOOP
         DBMS_OUTPUT.put_line('Id: ' || v_linha(i).pr_id || ' Produto: ' || v_linha(i).pr_nome ); 
    END LOOP;
END;


CREATE OR REPLACE PROCEDURE normaliza_banco (
    nulo IN NUMBER DEFAULT NULL
)
IS
BEGIN
    FOR cl IN (select nome, id from clientes) LOOP
        UPDATE clientes
        SET nome = upper(nome) where id = cl.id;
    END LOOP;

    FOR fr IN (select empresa, id from fornecedores) LOOP
        UPDATE fornecedores 
        SET empresa = upper(empresa) where id = fr.id;
    END LOOP;

    FOR prod IN (select produto, categoria, id from produtos) LOOP
        UPDATE produtos
        SET produto = upper(produto) where id = prod.id;
        UPDATE produtos 
        SET categoria = upper(categoria) where id = prod.id;
    END LOOP;
COMMIT;
END;

execute normaliza_banco();

create or replace PROCEDURE abastece_estoque (
    p_id_pr produtos.id%TYPE,
    p_id_fr produtos.id_fornecedor%TYPE,
    p_preco_compra produtos.preco_compra%TYPE,
    p_quantidade produtos.qt_estoque%TYPE
    )
IS
    v_preco_venda produtos.preco_venda%TYPE;

BEGIN
    v_preco_venda := ROUND((P_preco_compra*1.35),2);

    UPDATE produtos
    SET   id_fornecedor = p_id_fr
    WHERE id = p_id_pr;

    UPDATE produtos
    SET preco_compra = p_preco_compra
    WHERE id = p_id_pr;

    UPDATE produtos
    SET  preco_venda = v_preco_venda
    WHERE id = p_id_pr;

    UPDATE produtos
    SET  qt_estoque = qt_estoque + p_quantidade
    WHERE id = p_id_pr;
    
    INSERT INTO log_produtos (produto_id, dt_evento, evento)
    VALUES (p_id_pr, SYSDATE, 'Produto abastecido');
COMMIT;
END;

create or replace procedure del_por_id (
    p_tabela_nome IN VARCHAR2,
    p_id IN NUMBER
    )
IS
vSql VARCHAR2 (500);
BEGIN
    IF p_tabela_nome = 'itens_da_venda' THEN
        vSql :=  'DELETE FROM ' || p_tabela_nome || ' where id_venda = '|| p_id;
        EXECUTE IMMEDIATE vSql;
    ELSE 
        vSql :=  'DELETE FROM ' || p_tabela_nome || ' where id = '|| p_id;
        EXECUTE IMMEDIATE vSql;
    END IF ;
    COMMIT; 
END;


/*funções*/
create or replace FUNCTION calcula_idade (
    dt_nasc clientes.dt_nascimento%TYPE
)
RETURN
    NUMBER
IS
    idade NUMBER;
BEGIN
    idade := trunc((months_between(sysdate, dt_nasc))/12);
    return idade;
END;


create or replace FUNCTION transforma_peso (
     qt itens_da_venda.quantidade%TYPE
)
RETURN
    NUMBER
IS
    kg NUMBER;
BEGIN
    IF qt > 50 THEN 
        kg := qt/1000;
    ELSE 
        kg := qt;
    END IF;
return kg;
END;


/*triggers*/
CREATE TABLE log_produtos (
    produto_id NUMBER,
    dt_evento TIMESTAMP,
    evento VARCHAR2(100)
    )


CREATE OR REPLACE TRIGGER tg_produto_inserido
AFTER INSERT ON produtos
FOR EACH ROW
BEGIN
    INSERT INTO log_produtos (produto_id, dt_evento, evento)
    VALUES (:new.id, SYSDATE, 'Novo produto cadastrado');
END;

CREATE OR REPLACE TRIGGER tg_produto_removido
AFTER DELETE ON produtos
FOR EACH ROW 
BEGIN
    INSERT INTO log_produtos (produto_id, dt_evento, evento)
    VALUES (:old.id, SYSDATE, 'Produto removido');
END;


/* SCRIPT APRESENTAÇÃO */

EXECUTE insere_cliente(pnome=>p/*varchar2*/,pdt_nasc=>p/*date*/,pcpf=>p/*char*/,ptelefone=>p/*number*/,pemail_c=>p/*varchar2*/);
EXECUTE insere_cliente('Rodrigo Pereira', '04/08/00', '45609823409', 11985743542, 'rodrigo87@gmail.com')
EXECUTE insere_cliente('Patricia Ramos', '08/10/97', '7607954099', 11998445522, 'pati@gmail.com')
EXECUTE insere_cliente('Carolina Pereira', '09/07/97', '76080934099', 11998743542, 'carol87@gmail.com')
select * from clientes order by id desc

EXECUTE insere_fornecedores(pempresa=>p/*varchar2*/,pcnpj=>p/*char*/,pemail_f=>p/*varchar2*/,ptelefone=>p/*number*/);
EXECUTE insere_fornecedores ('ZONA Cerealista', '12345678901234', 'contato@zonacerealista.com', '113888590');
EXECUTE insere_fornecedores ('Armazem Cerealista', '82345675904234', 'contato@cerealista.com', '113999590');
select * from fornecedores order by id desc


EXECUTE insere_produto(pid_fornecedor=>p/*number*/,pcategoria=>p/*varchar2*/,pproduto=>p/*varchar2*/,ppreco_compra=>p/*float*/,ppreco_venda=>p/*float*/,pqt_estoque=>p/*number*/,pqt_minima=>p/*number*/);
EXECUTE insere_produto (2, 'GRÃOS/SEMENTES','chia', '19,7', '26,55', '1', '0,3');
EXECUTE insere_produto (3, 'Chás', 'folha de maracujá', '47,74', '63,39', '1', '0,3');
EXECUTE insere_produto (2, 'GRÃOS/SEMENTES','cevadinha', '65,00', '87,00', '1', '0,3');
EXECUTE insere_produto (3, 'Chás', 'Boldo', '34,00', '47,00', '1', '0,3');
select * from produtos order by id desc
select * from produtos where id = 230

set serveroutput on
EXECUTE insere_venda_atualiza_estoque(venda_nova=>v/*pl/sql boolean*/,pid_cliente=>p/*number*/,pdata=>p/*date*/,ptotal_da_venda=>p/*number*/,pid_produto=>p/*number*/,pquantidade=>p/*number*/,pvalor_unit=>p/*number*/,pvalor_tot=>p/*number*/);
EXECUTE insere_venda_atualiza_estoque(True,'180','21/11/2021','67,50','540','0,5','81,00','40,50');
EXECUTE insere_venda_atualiza_estoque(False,'180', '21/11/2021','67,50', '450','1','27,00','27,0');

EXECUTE insere_venda_atualiza_estoque(True,'100','24/11/2021','81,00','210','0,5','40','40,00');
EXECUTE insere_venda_atualiza_estoque(False,'100', '24/11/2021','81,00', '230','1','41','41');

select * from itens_da_venda 
full join vendas  on vendas.id =  itens_da_venda.id_venda 
where itens_da_venda.id_venda = (select max(itens_da_venda.id_venda) from itens_da_venda )

EXECUTE abastece_estoque(p_id_pr=>p/*number*/,p_id_fr=>p/*number*/,p_preco_compra=>p/*number*/,p_quantidade=>p/*number*/);
execute abastece_estoque('540','5', '60', '1' );
execute abastece_estoque('450','5', '20', '2' );

execute abastece_estoque('200','5', '74,60', '3' );

execute abastece_estoque('210','1', '40', '3' );
execute abastece_estoque('230','2', '41', '3' );
select * from produtos where id = 230

select * from log_produtos

execute get_cliente (360)
execute get_produtos (360)

execute del_por_id ('clientes', 350)
execute del_por_id ('vendas', 580)
execute del_por_id ('itens_da_venda', 580)
